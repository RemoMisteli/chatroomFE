<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="styles.css">
    <title>ChatRoom</title>
    <meta charset="UTF-8">

</head>

<body>
    <div class="title">
        <h1>ChatRoom</h1>
        <a class="active" href="index.html">ChatRoom</a>
        <a class="" href="search.html">Search</a>
        <a class="" href="adminpage.html">Adminpage</a>


    </div>

    <div class="element description">
        <p>Here you can chat with your friends</p>
    </div>



    <div class="element chat" id="chatMessages">
        <div id="message">

        </div>
    </div>

    <div class="element inputs">

        Name:<input class="usernNameField" id="usernameField" placeholder="your name">
        Message:<input class="messageField" id="messageField" placeholder="your message">
        <button class="sendButton" onclick="send()">send</button>
    </div>




    <script>

        var user;


        function writeToHtml() {
            if (document.getElementById('usernameField').value != user) {
                user = document.getElementById('usernameField').value;
                document.getElementById("message").innerHTML = '';

            }

            for (var i = 0; i < messages.length; i++) {

                if (document.getElementById("messageId-" + messages[i].id) == null) {

                    var bubble = document.createElement("div");

                    var bubbleMessage = document.createElement("div");

                    var bubbleUser = document.createElement("div");

                    var bubbleDate = document.createElement("div");


                    bubbleUser.appendChild(document.createTextNode(messages[i].user));
                    bubbleMessage.innerHTML = replaceEmotij(decodeQuestionmark(messages[i].message));

                    bubbleDate.appendChild(document.createTextNode(formatDate(messages[i].date)));

                    if (document.getElementById('usernameField').value == messages[i].user) {
                        bubble.className = "myBubble";

                        bubbleUser.className = "myBubbleUser";
                        bubbleMessage.className = "myBubbleMessage";
                        bubbleDate.className = "myBubbleDate";
                    } else {

                        bubble.className = "bubble";
                        bubbleUser.className = "bubbleUser";
                        bubbleMessage.className = "bubbleMessage";
                        bubbleDate.className = "bubbleDate";
                    }

                    bubble.appendChild(bubbleUser);
                    bubble.appendChild(bubbleMessage);
                    bubble.appendChild(bubbleDate);

                    bubble.id = "messageId-" + messages[i].id;



                    var parentElement = document.getElementById("message");
                    parentElement.appendChild(bubble);

                }
            }
        }

    </script>
    <script>

        // becaus ? dosent't work on a get reques(when you send date) and the get request is yused only because its a testproject for aprentices.
        var questionmarkString = "'',.''";
        var slashString = "''''...''''";
        var hashtagString = "''''......";
        var cornerOString = "....'''''....'";
        var cornerCStrin = "------....----";
        var semicolonString = "..''''.....'";
        function questionmarkReplce(message) {
            message = message.replaceAll("?", questionmarkString);

            message = message.replaceAll("/", slashString);

            message = message.replaceAll("#", hashtagString);

            message = message.replaceAll("[", cornerOString);
            message = message.replaceAll("]", cornerCStrin);
            message = message.replaceAll(";", semicolonString);





            return message;


        }
        function decodeQuestionmark(message) {

            message = message.replaceAll(questionmarkString, "?");

            message = message.replaceAll(slashString, "/");

            message = message.replaceAll(hashtagString, "#");

            message = message.replaceAll(cornerOString, "[");
            message = message.replaceAll(cornerCStrin, "]");
            message = message.replaceAll(semicolonString, ";");

            return message;
        }


    </script>
    <script>
        var unicqueCode = "&#x";
        function replaceEmotij(message) {

            message = message.replaceAll("3:)", unicqueCode + "1F608");
            message = message.replaceAll("o:)", unicqueCode + "1F607");
            message = message.replaceAll(":)", unicqueCode + "1F600");
            message = message.replaceAll(";)", unicqueCode + "1F609");
            message = message.replaceAll("Trump", unicqueCode + "1F4A9");
            message = message.replaceAll("-_-", unicqueCode + "1F611");
            message = message.replaceAll(":(", unicqueCode + "1F61E");
            message = message.replaceAll(":o", unicqueCode + "1F62F");
            message = message.replaceAll("<3", unicqueCode + "1F496");
            message = message.replaceAll(":||", unicqueCode + "1F637");
           



            return message;
        }

    </script>

    <script>window.onload = function () {
            getMessage();
        };
        window.setInterval(function () {
            getMessage();
        }, 1000);
    </script>

    <script>
        var xmlhttp = new XMLHttpRequest();
        var host="http://remospi.hopto.org:8080/remo";
        var url = host+"/chatroom/messages/";

        var messages;

        function getMessage() {
            xmlhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    messages = JSON.parse(this.responseText)
                    writeToHtml();

                }
            };
            xmlhttp.open("GET", url, true);
            xmlhttp.send();
        }

    </script>

    <script>
        function send() {
            var sendUrl = url + "send/";
            var name = document.getElementById('usernameField').value;
            var message = questionmarkReplce(document.getElementById('messageField').value);
            if (name != '' && message != '') {

                document.getElementById('messageField').value = "";

                sendUrl = sendUrl + name + "/";
                sendUrl = sendUrl + message;

                xmlhttp.open("GET", sendUrl, true);
                xmlhttp.send();

                getMessage();
            }



        }
    </script>
    <script>
        function formatDate(date) {
            var today = new Date();
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

            if (month.length < 2)
                month = '0' + month;
            if (day.length < 2)
                day = '0' + day;


            if (today.getDate() == day && today.getMonth() + 1 == month && today.getFullYear() == year) {

                return [d.getHours(), d.getMinutes()].join(':');

            } else {


                return [day, month, year].join('-');

            }
        }
    </script>
</body>

</html>